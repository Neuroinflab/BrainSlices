<html>
 <head>
  <title>Skrawki engine - test site.</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <link rel="icon" type="image/vnd.microsoft.icon" href="/static/gfx/nut.ico"/>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/main.css" />
  <script src="/static/js/jquery.js" type="text/javascript"></script>
  <script src="/static/js/html5slider.js" type="text/javascript"></script>
  <script src="/static/js/common.js" type="text/javascript"></script>
  <script src="/static/js/layer_stack.js" type="text/javascript"></script>
  <script src="/static/js/tile_layer.js" type="text/javascript"></script>
  <script src="/static/js/outline_layer.js" type="text/javascript"></script>
  <script src="/static/js/draggable_div.js" type="text/javascript"></script>
  <script src="/static/js/image_manager.js" type="text/javascript"></script>
  <script src="/static/js/synchronized_stacks.js" type="text/javascript"></script>
  <script src="/static/js/main.js" type="text/javascript"></script>
  <script type="text/javascript">

var move = false;

function startMove(event)
{
  move = true;
}


function processMove(event)
{
  if (move)
  {
    inspect();
  }
}

function inspect()
{//TODO
  $('#x').val(stacks.stacks[0].focusPointX);
  $('#y').val(stacks.stacks[0].focusPointY);
}

function stopMove(event)
{
  move = false;
}


function test()
{
  var x = $('#x').val();
  var y = $('#y').val();

  stacks.setFocusPoint(x, y);
  stacks.update();
  return false;
}

function rearrangeInterface()
{
  var nx = $('#nx').val();
  var ny = $('#ny').val();
  var display = $('#display').val();
  var width = display == 'matrix' ? null : parseInt(Math.max(100, 66 * nx / ny)) + '%';

  stacks.rearrange(nx, ny, width);
  stacks.arrangeInterface();
}

function compressStacks()
{
  var images = stacks.loadedImagesOrdered();
  stacks.rearrange(1, 1);
  for (var i = 0; i < images.length; i++)
  {
    if (!stacks.has(0, images[i]))
    {
      stacks.load(0, images[i], true);
    }
  }
  stacks.arrangeInterface();
  $('#nx').val(stacks.nx);
  $('#ny').val(stacks.ny);
}

function decompressStacks()
{
  var images = stacks.loadedImagesOrdered();
  var nx = $('#nx').val();
  var ny = $('#ny').val();
  var nxCor = nx * ny < images.length ?
              parseInt(Math.ceil(images.length / ny)) :
              nx;
  var display = $('#display').val();
  var width = display == 'matrix' ?
              null :
              parseInt(Math.max(100, 66 * nxCor / ny)) + '%';
  stacks.unloadAll();
  stacks.rearrange(nxCor, ny, width);
  for (var i = 0; i < images.length; i++)
  {
    stacks.load(i, images[images.length - 1 - i], true);
  }

  stacks.arrangeInterface();
  $('#nx').val(stacks.nx);
  $('#ny').val(stacks.ny);
}

function addLayer()
{
  var id = $('#id').val();
  var z = $('#z').val();
	stacks.addTileLayer(id, '/images/' + id, z, $('#id option:selected').html());
  return false;
}

//TODO
function addOutlineLayer()
{
  var id = 'Outline320'; //$('#id').val();
  var z = $('#z').val();

  stacks.stacks[0].loadOutlineLayer(id, '/outlines/wholeOutline/320.svg', z);

	inspect(); 
  return false;
}

function addTest()
{
  var id = $('#testSet').val();
  var subset = $('#testSubset').val();
  var z = $('#z').val();

  stacks.addTileLayer(id + '___' + subset, '/testImages/' + id + '/' + subset, z, id + '___' + subset);
  return false;
}

var testSubsets = null;
var id2name = {};
var stacks = null;

$(function()
{
  $('#userPanel').hide();
  $('#registerDiv').hide();
  $('#regeneratePasswordDiv').hide();
  $('#successDiv').hide();
  $('#logoutLink').hide();

  loginConsole = new CLoginConsole($('#userPanel'), $('#loginLink'), $('#logoutLink'),
                     function()
                     {
                       $('#logoutLink').text('Logout [' +
                                             loginConsole.isLoggedAs() + ']');
                     },
                     null,
                     null,
                     function()
                     {
                       $('#loginDiv').show();
                       $('#registerDiv').hide();
                       $('#successDiv').hide('');
                       $('#regeneratePasswordDiv').hide('');
                       $('.regenerateForm').val('');
                     });

  $('#registerButton').click(function() 
  {
    $('.loginForm').val('');
    $('#loginDiv').hide();
    $('#registerDiv').show();
    $('.loginMessages').text('');
    $('.formErrorMessages').text('');
  });

  $('form[name="registerForm"]').bind('submit',
  function() 
  {
    var login = $('#newLogin').val().trim();
    var nPassword = $('#registerPassword').val();
    var cPassword = $('#confirmPassword').val();
    var name = $('#name').val().trim();
    var eMail = $('#eMail').val().trim();

    $('form[name="registerForm"] .formErrorMessages').hide().text('');
    var permissionToGo = true;
    if (!validLogin(login))
    {
      $('#newLoginFieldError').show().text('Provide a valid login.');
      permissionToGo = false;
    }

    if (nPassword == '')
    {
      $('#newPasswordFieldError').show().text('Provide a password.');
      permissionToGo = false;
    }

    if (cPassword == '')
    {
      $('#confirmPasswordFieldError').show().text('Confirm the password.');
      permissionToGo = false;
    }

    if (name == '')
    {
      $('#nameFieldError').show().text('Provide a name.');
      permissionToGo = false;
    }

    if (nPassword != cPassword)
    {
      $('#confirmPasswordFieldError').show().text("Passwords do not match.");
      permissionToGo = false;
    }

    if (!validEmail(eMail,
                    permissionToGo ?
                    "Provided e-mail address is very unusual:\n"
                    + eMail + "\n"
                    + "- do you want to continue with it?" :
                    null))
    {
      $('#eMailFieldError').show().text('Provide a valid e-mail address.');
      permissionToGo = false;
    }

    if (permissionToGo)
    {
      loginConsole.ajax('/user/registerUser',
                        function(response)
                        {
                          if (response.status)
                          {
                            $('#registerDiv').hide();
                            $('#successDiv p').html(response.message)
                            $('#successDiv').show();
                            $('.registerForm').val('');
                          }
                          else
                          {
                            $('#registrationError').show().text(response.message);
                          }
                        },
                        {
                          login: login,
                          password: nPassword,
                          password2: cPassword,
                          name: name,
                          email: eMail
                        });
    }

    return false;
  });

  $('#backFromRegistrationOkDiv').click(function()
  {
    $('#successDiv').hide();
    $('#loginDiv').show();
  });

  $('#backFromRegister').click(function()
  {
    $('.registerForm').val('');
    $('#dontMatch').text('');
    $('#registerDiv').hide();
    $('#loginDiv').show();
  });

  $('#regeneratePasswordButton').click(function()
  {
    $('.loginForm').val('');
    $('#loginDiv').hide();
    $('.loginMessages').text('');
    $('.formErrorMessages').text('');
    $('#regeneratePasswordDiv').show();
  });

  $('form[name="regeneratePasswordForm"]').bind('submit',
  function()
  {
    $('form[name="regeneratePasswordForm"] .formErrorMessages').hide().text('');
    var login = $('#regenerateLogin').val().trim();
    var email = $('#regenerateEmail').val().trim();

    var permissionToGo = true;
    if (!validLogin(login))
    {
      $('#regenerateLoginError').show().text('Provide a valid login.');
      permissionToGo = false;
    }

    if (!validEmail(email,
                    permissionToGo ?
                    "Provided e-mail address is very unusual:\n"
                    + email + "\n"
                    + "- do you want to continue with it?" :
                    null))
    {
      $('#regenerateEmailError').show().text('Provide a valid e-mail address.');
      permissionToGo = false;
    }

    if (permissionToGo)
    {


      loginConsole.ajax('/user/regeneratePassword',
                        function(response)
                        {
                          if (response.status)
                          {
                            $('#regeneratePasswordDiv').hide();
                            $('#successDiv p').html(response.message);
                            $('#successDiv').show();
                            $('.regenerateForm').val('');
                          }
                          else
                          {
                            $('#regenerationError').show().html(response.message);
                          }
                        },
                        {
                          login: login,
                          email: email
                        });
    }

    return false;
  });


  $('#backFromRegenerate').click(function()
  {
    $('.regenerateForm').val('');
    $('#regeneratePasswordDiv').hide();
    $('#loginDiv').show();
  });

/**********************************************/

  var nx = 1;
  var ny = 1;

  stacks = new CSynchronizedStacksDisplay($('#sliceDisplay'), nx, ny,
                                          $('#controlPanel [name="synchronization"]:checked').length != 0,
                                          $('#controlPanel [name="zoom"]').val(),
                                          $('#x').val(), $('#y').val(),
                                          null, null,
                                          $('#controlPanel'),
                                          false, false, false,
                                          '/static/gfx');

  $('#sliceDisplay').bind('mousemove', processMove);
  $('#sliceDisplay').bind('mousedown', startMove);
  $('body').bind('mouseup', stopMove);
  //$('#sliceDisplay').bind('mouseout', stopMove);

  loginConsole.ajax('/images/_allImages',
                    function(data)
                    {
		                	for (var i in data.data)
		                	{
		                		$('select#id').append('<option value="' +
                                              data.data[i][1] + '">' +
                                              data.data[i][0] + '</option>');
		                		id2name[data.data[i][1]] = data.data[i][0];
		                	}
                    });

  $.ajax({
    type: 'GET',
    url: '/_testImages',
    data: '',
    dataType: 'json',
    success: function(data)
    {
      testSubsets = data;

      var testSets = [];
      for (var id in data)
      {
        testSets.push(id);
      }
      testSets.sort();

      var testSetOptions = '';
      while (testSets.length > 0)
      {
        testSetOptions += '<option>' + testSets.shift() + '</option>';
      }
      $('#testSet').html(testSetOptions);
      testSetChanged();
    },
    error: ajaxErrorHandler
  });

});

function testSetChanged()
{
  var subsets = testSubsets[$('#testSet').val()].slice(0);
  subsets.sort();
  var testSubsetOptions = '';
  while (subsets.length > 0)
  {
    testSubsetOptions += '<option>' + subsets.shift() + '</option>';
  }
  $('#testSubset').html(testSubsetOptions);
}

  </script>

 </head>    
 <body style="margin: 0pt; height:100%;">
  <div style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px; overflow: hidden;">
   <div id="sliceDisplay">
   </div>
   <!--%controlPanel%-->
  </div>
  <!--%userPanel%-->
 </body>
</html>

