<html>
  <head>
    <link rel="stylesheet" type="text/css" href="../static/css/main.css">
    <script src="/static/js/common.js" type="text/javascript"></script>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/interface.js" type="text/javascript"></script>
    <script src="/static/js/ajax.js" type="text/javascript"></script>
    <script src="/static/js/privileges_manager.js" type="text/javascript"></script>
    <script>


with (BrainSlices)
{
  var listBatches = function()
  {
    // redundant with CFileUploader.listBatches
  
    var $batchSelect = $('#privilegesPanel select[name="bid"]');
    $batchSelect.html('<option value="None" selected="selected">None</option>');
    loginConsole.ajax(
      '/upload/batchList',
      function(response)
      {
        if (!response.status)
        {
          alert(response.message);
          return;
        }
        var list = response.data;
        for (var i = 0; i < list.length; i++)
        {
          $batchSelect.append('<option value="' + list[i][0] + '">' +
                         escapeHTML(list[i][1]) + '</option>');
        }
      },
      null,
      null,
      null,
      null,
      {cache: false});
  };


  var listBatch = function()
  {
    var bid = $('#privilegesPanel select[name="bid"]').val();
    var query = (bid == 'None') ? '' : 'bid=' + bid;
  
    loginConsole.ajax(
      '/upload/batchDetails',
      function(response)
      {
        if (!response.status)
        {
          alert(response.message);
          return false;
        }
  
        var data = response.data;
        if (data.length == 0)
        {
          return;
        }
  
        var iids = [];
        var iMap = {};
  
        data.sort(function(a, b)
                  {
                    if (a.filename < b.filename)
                    {
                      return -1;
                    }
                    if (a.filename > b.filename)
                    {
                      return 1;
                    }
                    return a.iid - b.iid;
                  });
  
      	for (var i = 0; i < data.length; i++)
      	{
          var image = data[i];
          var iid = image.iid;
          iMap[iid] = image;
          iids.push(iid);
      	}
        loginConsole.ajax(
          '/upload/getPrivileges',
          function(response)
          {
            if (!response.status)
            {
              alert(response.message);
              return false;
            }
  
            privilegeManager.flush();
            tableManager.flush();
  
            //var $privilegesList = $('#privilegesPanel .layerList');
            //$privilegesList.empty();
  
            var data = response.data;
            for (var j = 0; j < data.length; j++)
            {
              var item = data[j];
  
              var iid = item[0];
              var privileges = item[1];
              var groups = item[2];
              var info = iMap[iid];
  
              var $row = $('<tr></tr>');
              $row.append($('<td draggable="true">' + iid + '</td>'));
              $row.append($('<td draggable="true"></td>').append(getThumbnail(iid, info.imageWidth, info.imageHeight, 120, 90)));
              function getCBs(iid)
              {
                var res = [];
                var cbs = [];
                function updatePrivileges()
                {
                  privilegeManager.changePublic(iid,
                                         cbs[0].filter(':checked').length > 0, 
                                         cbs[1].filter(':checked').length > 0, 
                                         cbs[2].filter(':checked').length > 0, 
                                         cbs[3].filter(':checked').length > 0,
                                         true);
                }
                for (var i = 0; i < 4; i++)
                {
                  var $cb = $('<input type="checkbox">'); // + (privileges[i] ? ' checked="checked">' : '>'));
                  $cb.bind('change', updatePrivileges);
                  cbs.push($cb);
                  var $td = $('<td></td>').append($cb);
                  res.push($td);
                }
  
                function onUpdate(privilege)
                {
                  if (privilege.view)
                  {
                    cbs[0].attr("checked", "checked");
                  }
                  else
                  {
                    cbs[0].removeAttr("checked");
                  }
  
                  if (privilege.edit)
                  {
                    cbs[1].attr("checked", "checked");
                  }
                  else
                  {
                    cbs[1].removeAttr("checked");
                  }
  
                  if (privilege.annotate)
                  {
                    cbs[2].attr("checked", "checked");
                  }
                  else
                  {
                    cbs[2].removeAttr("checked");
                  }
  
                  if (privilege.outline)
                  {
                    cbs[3].attr("checked", "checked");
                  }
                  else
                  {
                    cbs[3].removeAttr("checked");
                  }
                }
                return [res, onUpdate];
              }
              var cbs = getCBs(iid);
              for (var i = 0; i < 4; i++)
              {
                $row.append(cbs[0][i]);
              }
  
              //for (var i = 0; i < privileges.length; i++)
              //{
              //  $row.append($('<td>' + privileges[i] + '</td>'));
              //}
              $row.append($('<td>' + groups.join(' ') + '</td>'));
  
              privilegeManager.add(item, $row, cbs[1]);
              tableManager.add($row, iid);
             // $privilegesList.append($row);
            }
          },
          {iids: iids.join(',')});
      },
      query);
  
    return false;
  }

  var savePublicPrivileges = function()
  {
    privilegeManager.savePublic();
  }
}

var loginConsole = null;
var privilegeManager = null;
var tableManager = null;

$(function()
{
  loginConsole = new BrainSlices.ajax.CUserPanel(
                 $('#userPanel'),
                 $('#loginLink'),
                 $('#logoutLink'),
                 function()
                 {
                   listBatches();
                   $('#helloMessage').text('Logged as ' + loginConsole.isLoggedAs());
                 },
                 function()
                 {
                   listBatches();
                   $('#helloMessage').text('Not logged in');
                 },
                 null,
                 function()
                 {
                   $('.formErrorMessages').text(''); //XXX: is necessary?
                 });
  privilegeManager = new CImagePrivilegesManager(loginConsole);
  tableManager = new CTableManager($('#privilegesPanel table tbody.layerList'));

  $('#viewPrivilegeAll').bind('change', function()
  {
    privilegeManager.changePublic(null,
                                  $('#viewPrivilegeAll:checked').length > 0);
  });
  $('#editPrivilegeAll').bind('change', function()
  {
    privilegeManager.changePublic(null, null,
                                  $('#editPrivilegeAll:checked').length > 0);
  });
  $('#annotatePrivilegeAll').bind('change', function()
  {
    privilegeManager.changePublic(null, null, null,
                                  $('#annotatePrivilegeAll:checked').length > 0);
  });
  $('#outlinePrivilegeAll').bind('change', function()
  {
    privilegeManager.changePublic(null, null, null, null,
                                  $('#outlinePrivilegeAll:checked').length > 0);
  });
});



    </script>
  </head>
  <body>
   <a href="javascript:void(0)" id="logoutLink">logout</a>
   <a href="javascript:void(0)" id="loginLink">login</a>
   
   <p id="helloMessage">Not logged in</p>

   <div id="privilegesPanel">
    <select name="bid">
     <option selected="selected">None</option>
    </select>
    <a href="javascript:void(0)" onclick="return listBatch();">List</a>
    <table border>
     <thead>
      <tr>
       <th colspan="2">
        Image
       </th>
       <th colspan="4">
        Public privileges
        <button onclick="savePublicPrivileges();">Save</button>
       </th>
       <th rowspan="2">
        Groups
       </th>
      </tr>
      <tr>
       <th>
        IID
       </th>
       <th>
        Thumbnail
       </th>

       <th>
        View
       </th>
       <th>
        Edit
       </th>
       <th>
        Annotate
       </th>
       <th>
        Outline
       </th>
      </tr>
     </thead>
     <tfoot>
      <tr>
       <th colspan="2">
        All images
       </th>
       <td>
        <input type="checkbox" id="viewPrivilegeAll">
       </td>
       <td>
        <input type="checkbox" id="editPrivilegeAll">
       </td>
       <td>
        <input type="checkbox" id="annotatePrivilegeAll">
       </td>
       <td>
        <input type="checkbox" id="outlinePrivilegeAll">
       </td>
       <td>
        <button onclick="privilegeManager.reset();">Reset</button>
       </td>
      </tr>
     </tfoot>
     <tbody class="layerList">
     </tbody>
    </table>
   </div>

   <!--%userPanel%-->
  </body>
</html>

