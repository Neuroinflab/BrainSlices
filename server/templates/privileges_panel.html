<html>
  <head>
    <link rel="stylesheet" type="text/css" href="../static/css/main.css">
    <script src="/static/js/common.js" type="text/javascript"></script>
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/draggable_div.js" type="text/javascript"></script>
    <script src="/static/js/main.js" type="text/javascript"></script>
    <script>

var loginConsole = null;

function listBatches()
{
  // redundant with CFileUploader.listBatches

  var $batchSelect = $('#privilegesPanel select[name="bid"]');
  $batchSelect.html('<option value="None" selected="selected">None</option>');
  loginConsole.ajax(
    '/upload/batchList',
    function(response)
    {
      if (!response.status)
      {
        alert(response.message);
        return;
      }
      var list = response.data;
      for (var i = 0; i < list.length; i++)
      {
        $batchSelect.append('<option value="' + list[i][0] + '">' +
                       escapeHTML(list[i][1]) + '</option>');
      }
    },
    null,
    ajaxErrorHandler,
    'POST',
    {cache: false});
}

function listBatch()
{
  var bid = $('#privilegesPanel select[name="bid"]').val();
  var query = (bid == 'None') ? '' : 'bid=' + bid;

  loginConsole.ajax(
    '/upload/batchDetails',
    function(response)
    {
      if (!response.status)
      {
        alert(response.message);
        return false;
      }

      var data = response.data;
      if (data.length == 0)
      {
        return;
      }

      var iids = [];
      var iMap = {};

      data.sort(function(a, b)
                {
                  if (a.filename < b.filename)
                  {
                    return -1;
                  }
                  if (a.filename > b.filename)
                  {
                    return 1;
                  }
                  return a.iid - b.iid;
                });

    	for (var i = 0; i < data.length; i++)
    	{
        var image = data[i];
        var iid = image.iid;
        iMap[iid] = image;
        iids.push(iid);
    	}
      loginConsole.ajax(
        '/upload/getPrivileges',
        function(response)
        {
          if (!response.status)
          {
            alert(response.message);
            return false;
          }

          var $privilegesList = $('#privilegesPanel .layerList');
          $privilegesList.empty();

          var data = response.data;
          for (var i = 0; i < data.length; i++)
          {
            var item = data[i];

            var iid = item[0];
            var privileges = item[1];
            var groups = item[2];

            var $row = $('<tr></tr>');
            $row.append($('<td>' + iid + '</td>'));
            $row.append($('<td>' + privileges.join(' ') + '</td>'));
            $row.append($('<td>' + groups.join(' ') + '</td>'));
            $privilegesList.append($row);
          }
        },
        {iids: iids.join(',')});
    },
    query);

  return false;
}

$(function()
{
  loginConsole = new CUserPanel($('#userPanel'), $('#loginLink'), $('#logoutLink'),
                 function()
                 {
                   listBatches();
                   $('#helloMessage').text('Logged as ' + loginConsole.isLoggedAs());
                 },
                 function()
                 {
                   listBatches();
                   $('#helloMessage').text('Not logged in');
                 },
                 null,
                 function()
                 {
                   $('.formErrorMessages').text(''); //XXX: is necessary?
                 });
});

    </script>
  </head>
  <body>
   <a href="javascript:void(0)" id="logoutLink">logout</a>
   <a href="javascript:void(0)" id="loginLink">login</a>
   
   <p id="helloMessage">Not logged in</p>

   <div id="privilegesPanel">
    <select name="bid">
     <option selected="selected">None</option>
    </select>
    <a href="javascript:void(0)" onclick="return listBatch();">List</a>
    <table border>
     <thead>
      <tr>
       <th colspan="3">
        Image
       </th>
       <th colspan="4">
        Public privileges
       </th>
       <th rowspan="2">
        Groups
       </th>
      </tr>
      <tr>
       <th>
        IID
       </th>
       <th>
        Filename
       </th>
       <th>
        Thumbnail
       </th>

       <th>
        View
       </th>
       <th>
        Edit
       </th>
       <th>
        Annotate
       </th>
       <th>
        Outline
       </th>
      </tr>
     </thead>
     <tfoot>
     </tfoot>
     <tbody class="layerList">
     </tbody>
    </table>
   </div>

   <!--%userPanel%-->
  </body>
</html>

