<html>
 <head>
  <title>Skrawki engine - upload test site.</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <link rel="icon" type="image/vnd.microsoft.icon" href="/static/gfx/nut.ico"/>
  <link rel="stylesheet" type="text/css" href="/static/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/main.css" />
<!--  <link rel="stylesheet" type="text/css" href="/static/css/jquery-ui-1.10.3.dialog.min.css" /> -->
  <script src="/static/js/libs/jquery/jquery.js" type="text/javascript"></script>
<!--  <script src="/static/js/jquery-1.7.2.js" type="text/javascript"></script> -->
  <script src="/static/js/libs/html5slider.js" type="text/javascript"></script>
  <script src="/static/js/common.js" type="text/javascript"></script>
  <script src="/static/js/scope.js" type="text/javascript"></script>
  <script src="/static/js/libs/spark-md5.min.js" type="text/javascript"></script>
  <script src="/static/js/interface.js" type="text/javascript"></script>
  <script src="/static/js/upload.js" type="text/javascript"></script>
  <script src="/static/js/layer_stack.js" type="text/javascript"></script>
  <script src="/static/js/tile_layer.js" type="text/javascript"></script>
  <script src="/static/js/image_manager.js" type="text/javascript"></script>
  <script src="/static/js/layer_manager.js" type="text/javascript"></script>
  <script src="/static/js/synchronized_stacks.js" type="text/javascript"></script>
  <script src="/static/js/ajax.js" type="text/javascript"></script>
<!--  <script src="/static/js/jquery-ui-1.10.3.dialog.min.js" type="text/javascript"></script> -->
  <script type="text/javascript">

with ({STATUS_MAP: BrainSlices.gui.STATUS_MAP})
{
  var deleteButtons = {};

  function deleteImages()
  {
    var toDelete = [];
    var deleteMapping = {};
    for (var id in deleteButtons)
    {
      var $del = deleteButtons[id];
      if (!$del) continue;
      if ($del.filter(':checked').length == 0) continue;
      var image = images.getCachedImage(id);
      if (image == null) continue;
      var iid = image.info.iid;
      toDelete.push(iid);
      deleteMapping[iid] = id;
    }

    if (toDelete.length > 0 &&
        confirm("Do you really want to delete " +
                (toDelete.length == 1 ?
                 "the image" :
                 toDelete.length + " images") + " permanently?"))
    {
      loginConsole.ajax('/upload/deleteImages',
                        function(response)
                        {
                          if (!response.status)
                          {
                            alert(response.message);
                            return;
                          }
                          var data = response.data;
                          if (data.length != toDelete.length)
                          {
                            alert("Some of images not found in the database.");
                          }

                          var preserved = false;
                          for (var i = 0; i < data.length; i++)
                          {
                            var item = data[i];
                            if (item[1])
                            {
                              layerManager.removeLayer(deleteMapping[item[0]],
                                                       false);
                            }
                            else
                            {
                              preserved = true;
                            }
                          }
                          if (preserved)
                          {
                            alert("Not enough privileges to delete some of images.");
                          }
                          layerManager.updateOrder();
                        },
                        {iids: toDelete.join(',')});
    }
  }

  var batchDetails = function()
  {
  // Fetch info about images in selected batch
  // and append them to the uploaded files table
    var bid = $('#batchId').val();
    var query = (bid == 'None') ? '' : 'bid=' + bid;
  
    loginConsole.ajax('/upload/batchDetails',
                      function(data)
                      {
                        if (!data.status)
                        {
                          alert(data.message);
                          return false;
                        }
  
                        layerManager.flush();
                        fileUploader.reset();
                        data.data.sort(function(a, b)
                                       {
                                         if (a.filename < b.filename)
                                         {
                                           return -1;
                                         }
                                         if (a.filename > b.filename)
                                         {
                                           return 1;
                                         }
                                         return a.iid - b.iid;
                                       });
  
                    		for (var i = 0; i < data.data.length; i++)
                    		{
                          var image = data.data[i];
                          var id = image.iid;
                          if (image.status >= 6)
                          {
                            // status: completed
                            layerManager.autoAddTileLayer(image);
                          }
                          fileUploader
                            .append(image.filename
                                    + (image.status == 7 ?
                                       '' :
                                       ' (' + STATUS_MAP[image.status] + ')'),
                                    image.declaredFilesize,
                                    image.sourceFilesize,
                                    image.iid,
                                    image.sourceCRC32);
                    		}
                        layerManager.updateOrder();
                      },
                      query,
                      null,
                      'GET');
  //    //type: 'POST', //causes 412 error on refresh -_-
  
    return false;
  }

}

function listBatches()
{
  // fetch list of available batches
  // and update #batchId select
  var $batchSelect = $('#batchId')
    .html('<option value="None" selected="selected">None</option>');

  loginConsole.ajax(
    '/upload/batchList',
    function(response)
    {
      if (!response.status)
      {
        alert(response.message);
        return;
      }

      var list = response.data;
      for (var i = 0; i < list.length; i++)
      {
        $batchSelect.append('<option value="' + list[i][0] + '">' +
                            BrainSlices.gui.escapeHTML(list[i][1]) + '</option>');
      }
    },
    null, null, null,
    {cache: false});
}

function newBatch()
{
  // create (and select) a new batch
  var comment = $('#newBatchComment').val();
  var $batchSelect = $('#batchId');

  loginConsole.ajax(
    '/upload/newBatch',
    function(response)
    {
      if (!response.status)
      {
        alert(response.message);
        return;
      }
      $batchSelect.append('<option value="' + response.data.bid + '">' +
                     BrainSlices.gui.escapeHTML(response.data.comment) + '</option>');
      $batchSelect.val(response.data.bid);
    },
    {comment: comment},
    null,
    null,
    {cache: false});
}

function uploadFiles()
{

  fileUploader.submit($('#filesForUpload')[0].files,
                      $('#filterImageType').prop('checked'));
}

function updateFiles()
{
  // a dummy call just to see if an error message is being displayed
  fileUploader.filterImageFiles($('#filesForUpload')[0].files,
                                $('#filterImageType').prop('checked'));
}

function rearrangeInterface()
{
  var nx = $('#nx').val();
  var ny = $('#ny').val();
  var display = $('#display').val();
  var width = display == 'matrix' ? null : parseInt(Math.max(100, 66 * nx / ny)) + '%';

  stacks.rearrange(nx, ny, width);
  layerManager.arrangeInterface();
}

function compressStacks()
{
  var images = layerManager.loadedImagesOrdered();
  stacks.rearrange(1, 1);
  for (var i = 0; i < images.length; i++)
  {
    if (!stacks.has(0, images[i]))
    {
      layerManager.load(0, images[i], true);
    }
  }
  layerManager.arrangeInterface();
  $('#nx').val(stacks.nx);
  $('#ny').val(stacks.ny);
}

function decompressStacks()
{
  var images = layerManager.loadedImagesOrdered();
  var nx = $('#nx').val();
  var ny = $('#ny').val();
  var nxCor = nx * ny < images.length ?
              parseInt(Math.ceil(images.length / ny)) :
              nx;
  var display = $('#display').val();
  var width = display == 'matrix' ?
              null :
              parseInt(Math.max(100, 66 * nxCor / ny)) + '%';
  layerManager.unloadAll();
  stacks.rearrange(nxCor, ny, width);
  for (var i = 0; i < images.length; i++)
  {
    //stacks.load also shall work
    layerManager.load(i, images[images.length - 1 - i], true);
  }

  layerManager.arrangeInterface();
  $('#nx').val(stacks.nx);
  $('#ny').val(stacks.ny);
}

// XXX: Some quick hacks

function saveUpdated()
{
  //TODO: move to layerManager or so...
  layerManager.images.saveUpdatedTiled();
}

function updatePixelSize()
{
  var ps = parseFloat($('#nps').val());
  layerManager.images.updateImage(null, null, null, ps);
}

function updateLeft()
{
  var nleft = parseFloat($('#nleft').val());
  layerManager.images.updateImage(null, nleft);
}

function updateTop()
{
  var ntop = parseFloat($('#ntop').val());
  layerManager.images.updateImage(null, null, ntop);
}

function updateStatus()
{
  var nstatus = parseInt($('#nstatus').val());
  layerManager.images.updateImageStatus(null, nstatus);
}

function centerImage(id)
{
  layerManager.images.apply(id, function(image, updateIfeace)
  {
    var info = image.info;
    var factor = -0.5 * info.pixelSize;
    var imageLeft = factor * info.imageWidth;
    var imageTop = factor * info.imageHeight;
    image.updateInfo(imageLeft, imageTop, null, null, updateIfeace);
  });
}

function resetImage(id)
{
  layerManager.images.apply(id, function(image, updateIface)
  {
    image.reset(updateIface);
  });
}

var loginConsole = null;
var uploadedFiles = null;
var fileUploader = null;
var images = null;
var stacks = null;

$(document).ready(function()
{
	loginConsole = new BrainSlices.ajax.CUserPanel(
            $('#userPanel'),
            $('#loginLink'),
            $('#logoutLink'),
	          function()
	          {
	            //$('#logoutLink').text('Logout [' +
	            //                      loginConsole.isLoggedAs() + ']');
              if (fileUploader != null)
              {
                listBatches();
              }
	          },
	          function()
            {
              if (fileUploader != null)
              {
                listBatches();
              }
            });
	
  uploadedFiles = new CUploadedImages($('#upload table.uploaded>tbody'),
                                      null,
                                      $('#upload_status_message'));
  fileUploader = new CFileUploader(
    loginConsole, uploadedFiles, $('#brokenDuplicatePanel'),
    function(callback)
    {
      var $batchSelect = $('#batchId');

      var bid = $batchSelect.val();
      if (bid != 'None')
      {
        callback(parseInt(bid));
        return;
      }

      loginConsole.ajax(
        '/upload/newBatch',
        function(response)
        {
          if (!response.status)
          {
            alert(response.message);
            return;
          }

          $batchSelect.append('<option value="'
                              + response.data.bid + '">'
                              + BrainSlices.gui.escapeHTML(response.data.comment)
                              + '</option>');
          $batchSelect.val(response.data.bid);
          callback(response.data.bid);
        },
        null, null, null,
        {cache: false});
    });

  var nx = 1;
  var ny = 1;

  images = new BrainSlices.api.CImageManager(loginConsole);
  stacks = new BrainSlices.api.CSynchronizedStacksDisplay($('#sliceDisplay'), nx, ny,
                                          $('#controlPanel [name="synchronization"]:checked').length != 0,
                                          $('#controlPanel [name="zoom"]').val(),
                                          $('#x').val(), $('#y').val(),
                                          null, null,
                                          $('#controlPanel'),
                                          '/static/gfx', images);
  layerManager = new CLayerManager($('#controlPanel .layerList'), stacks,
                                   loginConsole,
  {
    addTileLayer:
    function(info)
    {
      var id = info.iid;

      if (this.has(id)) return;

      var image = null;
      var path = '/images/' + id;

      var thisInstance = this

      // making the layer-related row
      var $row =  $('<tr></tr>');
      var $drag = $('<td draggable="true">' + info.filename + '</td>');

      var dragMIME = [];

      $row.append($drag);

      // visibility interface
      var $visibility = $('<td></td>');
      $row.append($visibility);

      //adjustment
      var $adjust = $('<input type="checkbox">');
      var $iface = $('<span style="display: none;">' +
                      '<input type="number" class="imageLeft">' +
                      '<input type="number" class="imageTop">' +
                      '<input type="number" class="pixelSize">' +
                      '<select name="status">' +
                       '<option value="6">Completed</option>' +
                       '<option value="7">Accepted</option>' +
                      '</select>' +
                     '</span>');

      $adjust.bind('change', function()
      {
        if ($adjust.filter(':checked').length  != 0)
        {
          $iface.show();
          thisInstance.images.startAdjustment(id);
        }
        else
        {
          $iface.hide();
          thisInstance.images.stopAdjustment(id);
        }
      });

      $iface.find('input').bind('change', function()
      {
        if (image)
        {
          var imageLeft = parseFloat($iface.find('input.imageLeft').val());
          var imageTop = parseFloat($iface.find('input.imageTop').val());
          var pixelSize = parseFloat($iface.find('input.pixelSize').val());
          image.updateInfo(imageLeft, imageTop, pixelSize, null, false);
        }
      });

      $iface.find('select[name="status"]').bind('change', function()
      {
        if (image)
        {
          var status = parseInt($iface.find('select[name="status"]').val());
          image.updateInfo(null, null, null, status, false);
        }
      });

      function onUpdate()
      {
        var info = this.info;
        $iface.find('input.imageLeft').val(info.imageLeft);
        $iface.find('input.imageTop').val(info.imageTop);
        $iface.find('input.pixelSize').val(info.pixelSize);
        $iface.find('select[name="status"]').val(info.status);
      }

      $row.append($adjust, $iface);

      //removal

      var $rem = $('<button>Remove</button>');

      $rem.bind('click', function()
      {
        thisInstance.tableManager.remove(id);
      });
      $row.append($('<td></td>').append($rem));

      //deletion
      var $del = $('<input type="checkbox">');
      deleteButtons[id] = $del;
      $row.append($('<td></td>').append($del));

      this.addTileLayer(id, $row, $visibility, null, null,
                        function()
                        {
                          delete deleteButtons[id];
                        },
                        path, info, false,
                        function(img)
                        {
                          image = img;
                        },
			null, null,onUpdate);

    }
  });
  
});

  </script>

 </head>    
 <body style="margin: 0pt; height:100%;">
  <div style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px; overflow: hidden;">
   <div id="sliceDisplay">
   </div>
   <!--%controlPanel%-->
  </div>
	<!--<div id="dialog" title="Broken and duplicate uploads found!"></div>-->
  <!--%brokenDuplicatePanel%-->
  <!--%userPanel%-->
 </body>
</html>

